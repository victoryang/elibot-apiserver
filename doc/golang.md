# Some ticks for golang

## timer
1. Golang timer realized as a heap structure

  +--------+                                                                                                     
                                          | timers |                                                                                                     
                                          +----+---++----+----+----+----+----+-----------------------+----+                                              
                                          |    |    |    |    |    |    |    |                       |    |                                              
                                          |  0 |  1 |  2 |  3 |  4 |  5 |  6 |            ...        | 63 |                                              
                                          +----+----+----+----+----+----+----+-----------------------+----+                                              
                                              |                                                         |                                                
                                              |                                                         |                                                
                                              |                                                         |                                                
                                              |                                                         |                                                
                                              |                                                         |                                                
                                              | |                                          |            |    |                                          |
                                              | |          +--------------------+          |            |    |          +--------------------+          |
                                              | |--------> | cacheline size * N | <--------+            |    |--------> | cacheline size * N | <--------+
                                              | |          +--------------------+          |            |    |          +--------------------+          |
                                              | +-------------+-----------------+----------+            |    +-------------+-----------------+----------+
                                              +>|timersBucket |                 |          |            +--->|timersBucket |                 |          |
                                                +-------------+-----------------+   pad    |                 +-------------+-----------------+   pad    |
                                                |          lock mutex           |          |                 |          lock mutex           |          |
                                                +-------------------------------+          |                 +-------------------------------+          |
                                                |             gp *g             |          |                 |             gp *g             |          |
                                                +-------------------------------+          |                 +-------------------------------+          |
                                                |         created bool          |          |                 |         created bool          |          |
                                                +-------------------------------+          |    ........     +-------------------------------+          |
                                                |         sleeping bool         |          |                 |         sleeping bool         |          |
                                                +-------------------------------+          |                 +-------------------------------+          |
                                                |       rescheduling bool       |          |                 |       rescheduling bool       |          |
                                                +-------------------------------+          |                 +-------------------------------+          |
                                                |       sleepUntil int64        |          |                 |       sleepUntil int64        |          |
                                                +-------------------------------+          |                 +-------------------------------+          |
                                                |         waitnote note         |          |                 |         waitnote note         |          |
                                                +-------------------------------+          |                 +-------------------------------+          |
                                                |          t []*timer           |          |                 |          t []*timer           |          |
                                                +-------------------------------+----------+                 +-------------------------------+----------+
                                                                |                                                                                        
                                                                |                                                                                        
                                                                |                                                                                        
                                                                v                                                                                        
                                                              +---+                                                                                      
                                                              | 0 |                                                                                      
                                                              +---+                                                                                      
                                                                |                                                                                        
                                                                |                                                                                        
                                                                |                                                                                        
                                                                |                                                                                        
                                                                v                                                                                        
                                                        +---+---+---+---+                                                                                
                                                        | 1 | 2 | 3 | 4 |                                                                                
                                                        +-+-+-+-+-+-+-+-+                                                                                
                        +---------------------------------+   |   |   +------------------------------------------+                                       
                        |                              +------+   +--------+                                     |                                       
                        v                              |                   |                                     v                                       
                +---+---+---+---+                      v                   v                             +---+---+---+---+                               
                |   |   |   |   |              +---+---+---+---+   +---+---+---+---+                     |   |   |   |   |                               
                +-+-+-+-+---+---+              |   |   |   |   |   |   |   |   |   |                     +---+---+-+-+-+-+                               
                  |   |                        +---+---+---+---+   +---+---+---+---+                               |   |                                 
        +---------+   +---------+                                                                        +---------+   +-----+                           
        |                       |                                                                        |                   |                           
        |                       |                                                                        |                   |                           
        v                       v                                                                        v                   v                           
+---+---+---+---+       +---+---+---+---+                                                        +---+---+---+---+   +---+---+---+---+                   
|   |   |   |   |       |   |   |   |   |                  .................                     |   |   |   |   |   |   |   |   |   |                   
+---+---+---+---+       +---+---+---+---+                                                        +---+---+---+---+   +---+---+---+---+         


2. In time.Sleep, no function body for some function, like Sleep, startTimer...
It's go link function, which is defined in other place

In package runtime
    // startTimer adds t to the timer heap.
    //go:linkname startTimer time.startTimer
    func startTimer(t *timer) {
            if raceenabled {
                    racerelease(unsafe.Pointer(t))
            }
            addtimer(t)
    }

It is defined here and linked to pakcage time with name startTimer